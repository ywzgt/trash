name: Pack VS
on:
  workflow_dispatch:
jobs:
  run:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        install: git p7zip unzip
    - name: Modify Visual Studio
      shell: powershell
      run: |
        $vsPath = (& "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -property installationPath).Trim()
        $args = "modify --installPath `"$vsPath`" --quiet --norestart --add Microsoft.VisualStudio.Component.VC.ATLMFC --add Microsoft.VisualStudio.Component.VC.MFC.ARM64 --add Microsoft.VisualStudio.Component.VC.Tools.ARM64 --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Workload.NativeDesktop"
        $p = Start-Process `
          -FilePath "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe" `
          -ArgumentList $args `
          -Wait -PassThru
        if ($p.ExitCode -ne 0 -and $p.ExitCode -ne 3010) { exit $p.ExitCode }
        Write-Host "Visual Studio modification completed (exit code $($p.ExitCode))"

    - name: Package Visual Studio
      run: du -sh /c/Program\ Files*/Microsoft\ Visual\ Studio
      shell: msys2 {0}
    - name: Setup tmate ssh session
      if: ${{ ! cancelled() }}
      uses: mxschmitt/action-tmate@v3
